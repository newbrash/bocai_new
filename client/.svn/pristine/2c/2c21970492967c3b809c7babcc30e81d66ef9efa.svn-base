<template>
  <div class="contanier flex flow-col">
    <!-- 头部 -->
    <header class="dent-header flex justify-sb">

      <span dentHoverclass="hoverclass"
            @click="$router.go(-1)"
            class="flex iconfont icon-left click-icon"></span>

      <div class="hecai flex justify-sb">

        <div class="brief flex">
          <div class="avatar">
            <img :src="avatar">
          </div>
          <div class="brief-info flex flow-col justify-sa">
            <span class="fz-18 font-theme">
              {{gameName}}
            </span>
            <span v-if="Object.keys(recentInfo).length"
                  class="fz-12 fontc-6">第{{nextIssue}}期</span>
          </div>
        </div>

        <div class="time-left flex flow-col justify-sa">
          <span class="fz-18 font-theme">{{timer.timeToOpen}}</span>
          <span class="fz-12 fontc-3">即将开奖......</span>
        </div>

      </div>
    </header>

    <!-- 开奖列表 -->
    <div class="hecai-list bgc-fff">
      <template v-if="Object.keys(recentInfo).length">
        <div v-for="item in recentInfo"
             class="hecai-item">
          <div class="hecai-item-info flex justify-sb fontc-6 fz-12">
            <span>第{{item.issue}}期</span>
            <span>{{item.time}}</span>
          </div>
          <!-- 6合彩 -->
          <template v-if="key === '6hecai'">
            <openNum :openNumObj="JSON.parse(item.code)"
                     :showAnimals="false"></openNum>
          </template>
          <!-- 江苏快三 -->
          <template v-if="key === 'jsks'">
            <div class="jsks flex">
              <div class="dice-wrap flex justify-ct">
                <img v-for="n in 3"
                     class="dice">
              </div>
              <span class="fontc-9">和值: <span class="fontc-3">16</span></span>
            </div>
          </template>
        </div>
      </template>
      <!-- loading提示 -->
      <div v-else
           style="height: 50vh;"
           class="flex justify-ct flow-col">
        <template v-if="noHistoryOrder">
          <span class="iconfont icon-empty fontc-9 empty-size"></span>
          <span class="fz-16"
                style="line-height: 3;">没有数据</span>
        </template>
        <mt-spinner v-else
                    color="#e62b00"
                    type="fading-circle"></mt-spinner>
      </div>
    </div>

  </div>
</template>

<script>
import {countDownFunc} from '@/mixins/mixins'
import { Toast } from 'mint-ui';

export default {
  mixins: [countDownFunc],
  components:{
    openNum: () => import('@/components/game/6hecai/compoent-openNum')
  },
  data(){
    return{
      /* 数据 */
      recentInfo:[],  //近期开奖信息
      nextIssue:0,  //最新期数
      key:'', //游戏的key

      /* 状态 */
      gameName:'',  //游戏的名字
      avatar:'',  //游戏的图标
      noHistoryOrder: false, //没有跟多订单
    }
  },
  methods:{

    //请求 赔率 数据
    getOddsData() {
      let gameGongHost  = this.GLOBAL.gameGongHost;
      let sendDataToServer = () => {
        this.senddata({type:"recentOpen",game:this.key});
      }

      //请求数据
      if (!this.GLOBAL.gameSocketHand) {
        this.createSocket(gameGongHost, () => {
          this.dealOnMessage(); //创建连接成功之后 监听返回的信息
          sendDataToServer();
        });
      } else {
        this.dealOnMessage(); //已经创建连接 监听返回的信息
        sendDataToServer();
      }
    },

    //处理返回的数据
    dealOnMessage() {
      this.onmessage( (res) => {
        res = JSON.parse(res)
        //心跳
        if(res.code === 'pong') {
          this.senddata({ type: "ping" });
          return;
        };
        //订单信息
        if(res instanceof Array){
          this.recentInfo = res;
          if(res.length === 0){
            Toast({
              message:'没有历史注单',
              duration: 1500
            });
            this.noHistoryOrder = true;
          }
          console.log('%c近期开奖','color:red;');
          console.dir(res);
        }
      })
    }

  },
  mounted(){
    let { key, gameName } = this.$route.query;
    this.key = key;
    this.gameName = gameName;
    this.nextIssue = this.GLOBAL[key].nextIssue;
    this.avatar = this.GLOBAL[key+'Img'];
    //从全局变量读取并且启动倒计时
    let {countdown,interval} = this.GLOBAL[key];
    countdown && this.countTime(countdown,interval,'timeToOpen');

    this.$parent.tabbarShow = false;
    this.getOddsData();
  }
}
</script>

<style scoped>
.hoverclass {
  background: rgba(0, 0, 0, 0.1);
}
.contanier {
  padding: 0;
  height: 100vh;
}
.hecai-list {
  flex: 1;
  width: 100%;
  overflow: auto;
}
/* 头部 */
.dent-header {
  width: 100%;
  height: 18vw;
  background: #57d6dd;
}
.click-icon {
  flex: 1;
  padding-left: 2vw;
  height: 100%;
  color: #fff;
  font-size: 20px;
}
.hecai {
  width: 87.5vw;
  height: 14vw;
  background: white;
  border-top-left-radius: 7vw;
  border-bottom-left-radius: 7vw;
}
.avatar {
  margin-left: 1vw;
  margin-right: 2vw;
  width: 12vw;
  height: 12vw;
  border-radius: 50%;
  background: #e3e5e8;
  overflow: hidden;
}
.avatar img {
  width: 100%;
  height: 100%;
}
.brief {
  height: 100%;
}
.brief-info {
  align-items: flex-start;
  height: 100%;
}
.empty-size {
  font-size: 35vw;
}
/* 开奖列表 */
/* 6hecai */
.hecai-item {
  padding: 0 2vw 2vw;
  border-bottom: 1px solid #e5e5e5;
}
.hecai-item-info {
  line-height: 10vw;
}
/* jsks */
.jsks {
  margin: 1vw 0;
}
.dice-wrap {
  margin-right: 4vw;
  padding: 2vw 5vw;
  background: #7777bf;
  border-radius: 4vw;
}
.dice {
  width: 6vw;
  margin: 0 2vw;
  height: 6vw;
  background: #f2f5f8;
}
</style>
